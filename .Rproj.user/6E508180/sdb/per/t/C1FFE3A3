{
    "contents" : "SimData <- function(Nyears, AgeMax, SigmaR, M, F1, S_a, \n\tSigmaF, Fdynamics, Rdynamics, R0, CVlen, mids, highs, lows,\n\tW_a, L_a, Mat_a, Amat, Fequil, comp_sample=1000,\n\tnburn=50){\n\n\t## SB_t = spawning biomass over time\n\t## F_t = fishing mortality over time\n\t## Cn_at = number of individuals that die from fishing mortality\n\t## N_at = abundance by number at age over time\n\n\t##########################\n\t## Initial calcs\n\t##########################\n\n\ttyears <- nburn+Nyears\n\n\n\t##########################\n\t## Random variables\n\t##########################\n\n  RecDev <- rnorm(tyears, mean=-(SigmaR^2)/2, sd=SigmaR)\n\tFishDev <- rnorm(tyears, mean=-(SigmaF^2)/2, sd=SigmaF)\n\n\t##########################\n\t## Data objects\n\t##########################\n\tSB_t <- F_t <- R_t <- rep(NA, tyears)\t\t\t\t\t\t\t\t\n\tCn_at <- N_at <- matrix(NA, nrow=AgeMax+1, ncol=tyears)\n\n\t#####################################\n\t## Fishing and recruitment dynamics\n\t#####################################\t\n\n\tif(Fdynamics==\"Ramp\") Framp_t <- c(rep(0.01, nburn), \"rampup\"=seq(F1, Fmax, length=floor(Nyears/2)), \n\t\t\"peak\"=rep(Fmax, floor((Nyears-floor(Nyears/2))/2)), \n\t\t\"managed\"=rep(Fmax/3, Nyears-floor(Nyears/2)-floor((Nyears-floor(Nyears/2))/2)))\n\tif(Fdynamics==\"Constant\") Fconstant_t <- c(rep(0.01, nburn),rep(Fequil, Nyears))\n\tif(Fdynamics==\"Increasing\") Finc_t <- c(rep(0, nburn), ((1-0.01)/(Nyears-1))*1:Nyears)\n\n\tif(Rdynamics==\"Pulsed\") Rpulse_t <- c(rep(R0, nburn), \"initial\"=rep(R0, floor(Nyears/3)),\n\t\t\"pulse_up\"=rep(R0*3, floor(Nyears/3)), \"pulse_down\"=rep(R0, Nyears-floor(Nyears/3)))\n\tif(Rdynamics==\"Constant\") Rconstant_t <- rep(R0, tyears)\n\n\t##########################\n\t## Initialization\n\t##########################\n\tif(Fdynamics==\"Endogenous\") F_t[1] <- 0.01\n\tif(Fdynamics==\"Ramp\") F_t[1] <- Framp_t[1]\n\tif(Fdynamics==\"Constant\") F_t[1] <- Fconstant_t[1]\n\tif(Fdynamics==\"Increasing\") F_t[1] <- Finc_t[1]\n\n\tR_t[1] <- R0\n\n\t## year 1\n\tfor(a in 1:length(L_a)){\n\t\tif(a==1){\n\t\t\tN_at[a,1] <- R_t[1]\n\t\t}\n\t\tif(a>1 & a<length(L_a)){\n\t\t\tN_at[a,1] <- N_at[a-1,1]*exp(-M-F_t[1]*S_a[a-1])\n\t\t}\n\t\tif(a==length(L_a)){\n\t\t\tN_at[a,1] <- (N_at[a-1,1]*exp(-M-F_t[1]*S_a[a-1]))/(1-exp(-M-F_t[1]*S_a[a-1]))\n\t\t}\n\n\t}\n\tSB_t[1] <- sum(N_at[,1] * W_a * S_a)\n\tCn_at[,1] <- N_at[,1] * (1-exp(-M - F_t[1]*S_a)) * (F_t[1]*S_a)/(M+F_t[1]*S_a)\n\n\t##########################\n\t## Projection\n\t##########################\n\tNa0 <- rep(NA, length(W_a))\n\t\tif(Rdynamics==\"Pulsed\"){\n\t\t\tR0 <- median(Rpulse_t[-c(1:nburn)])\n\t\t}\n\tNa0[1] <- R0\n\tfor(a in 2:length(W_a)){\n\t\tNa0[a] <- R0 * exp(-M*(a-1))\n\t}\n\tSB0 <- sum(Na0[-1]*Mat_a[-1]*W_a[-1])\n\n\tfor(y in 2:tyears){\n\t\t## fishing effort and recruitment, not dependent on age structure\n\t\tif(Fdynamics==\"Endogenous\"){\n\t\t\tif(y <= nburn) F_t[y] <- 0.01\n\t\t\tif(y > nburn) F_t[y] <- F_t[y-1]*(SB_t[y-1]/(Fequil*SB0))^Frate * exp(FishDev[y])\n\t\t}\n\t\tif(Fdynamics==\"Ramp\"){\n\t\t\tF_t[y] <- Framp_t[y] * exp(FishDev[y])\n\t\t}\n\t\tif(Fdynamics==\"Constant\"){\n\t\t\tF_t[y] <- Fconstant_t[y] * exp(FishDev[y])\n\t\t}\n\t\tif(Fdynamics==\"Increasing\"){\n\t\t\tF_t[y] <- Finc_t[y] * exp(FishDev[y])\n\t\t}\n\t\tif(Rdynamics==\"Constant\"){\n\t\t\tR_t[y] <- Rconstant_t[y] * exp(RecDev[y])\n\t\t}\n\t\tif(Rdynamics==\"Pulsed\"){\n\t\t\tR_t[y] <- Rpulse_t[y] * exp(RecDev[y])\n\t\t}\n\t\tif(Rdynamics==\"BH\"){\n    \t\tR_t[y] <- (4 * h * R0 * SB_t[y-1] / ( SB0*(1-h) + SB_t[y-1]*(5*h-1))) * exp(RecDev[y])\n    \t}\n\t    \n\t    ## age-structured dynamics\n\t    for(a in 1:length(L_a)){\n\t    \tif(a==1){\n\t    \t\tN_at[a,y] <- R_t[y]\n\t    \t}\n\t    \tif(a>1 & a<length(L_a)){\n\t    \t\tN_at[a,y] <- N_at[a-1,y-1]*exp(-M-F_t[y-1]*S_a[a-1])\n\t    \t}\n\t    \tif(a==length(L_a)){\n\t    \t\tN_at[a,y] <- (N_at[a-1,y-1] + N_at[a,y-1])*exp(-M-F_t[y-1]*S_a[a-1])\n\t    \t}\n\t    }\n    \t## spawning biomass\n    \tSB_t[y] <- sum((N_at[,y] * W_a * Mat_a)[-1])\n    \t## catch\n    \tCn_at[,y] <- N_at[,y] * (1-exp(-M-F_t[y]*S_a)) * (F_t[y]*S_a)/(M+F_t[y]*S_a)\n\t}\n\tCn_t <- colSums(Cn_at)\n\tC_t <- Cn_t\n\tN_t <- colSums(N_at[-1,])\n\tD_t <- SB_t/SB0\n\n    ################################################\n\t## Probability being in a length bin given age\n\t################################################\n    lbprobs <- function(mnl,sdl) return(pnorm(highs,mnl,sdl)-pnorm(lows,mnl,sdl))\n    vlprobs <- Vectorize(lbprobs,vectorize.args=c(\"mnl\",\"sdl\"))\n    plba <- t(vlprobs(L_a,L_a*CVlen))\n    plba <- plba/rowSums(plba)\n\n    ################################################\n\t## Probability being in harvested at an age\n\t################################################\n    page <- matrix(ncol=dim(plba)[1], nrow=tyears)\n    for (y in 1:tyears) page[y,] <- N_at[,y] * S_a\n    page <- page/rowSums(page)    \n\n    ################################################\n\t## Probability of sampling a given length bin\n\t################################################\n    plb <- matrix(ncol=length(mids), nrow=tyears)\n    for (y in 1:tyears) plb[y,] <- page[y,] %*% plba\n    plb <- plb/rowSums(plb)    \n\n    #######################\n\t## Length frequencies \n\t#######################\n    LF <- array(0, dim=dim(plb))\n      rownames(LF) <- 1:tyears\n    for(y in 1:tyears){\n    \tLF[y,] <- rmultinom(n=1, size=comp_sample, prob=plb[y,])\n    }\n\n    ML_t <- rowMeans(LF*mids)\n\n\n    ########################################################\n\t## True mean length in vulnerable population each year \n\t########################################################\n\tL_t <- vector(length=tyears)\n  VL <- matrix(NA, nrow=tyears, ncol=ncol(plb))\n\tfor(y in 1:tyears){\n\t\tvul_pop <- sum(N_at[,y]*S_a)\n\t\tvul_lengths <- sum(vul_pop*plb[y,]*mids)\n    VL[y,] <- vul_pop*plb[y,]*mids\n\t\tL_t[y] <- vul_lengths/vul_pop\n\t}\n\n\t########################################################\n\t## cut out burn-in\n\t########################################################\n\n\tLFout <- LF[-c(1:nburn),]\n\t\trownames(LFout) <- 1:Nyears\n\n\tC_tout <- C_t[-c(1:nburn)]\n\n\tR_tout <- R_t[-c(1:nburn)]\n\tN_tout <- N_t[-c(1:nburn)]\n\tSB_tout <- SB_t[-c(1:nburn)]\n\tD_tout <- D_t[-c(1:nburn)]\n\tF_tout <- F_t[-c(1:nburn)]\n\tL_tout <- L_t[-c(1:nburn)]\n\tN_atout <- N_at[,-c(1:nburn)]\n  VL_out <- VL[-c(1:nburn),]\n\n\n    DataList <- list(\"C_t\"=C_tout, \"VL\"=VL_out,\n    \t\"LF\"=LFout, \"SigmaR\"=SigmaR, \"R_t\"=R_tout, \"N_t\"=N_tout, \"SB_t\"=SB_tout, \"D_t\"=D_tout, \"F_t\"=F_tout, \n    \t\"L_t\"=L_tout, \"N_at\"=N_atout, \"Amat\"=Amat, \"Mat_a\"=Mat_a, \"SB0\"=SB0, \"Nyears\"=Nyears, \"L_a\"=L_a,\n    \t\"W_a\"=W_a, \"AgeMax\"=AgeMax, \"M\"=M, \"S_a\"=S_a, \"plb\"=plb, \"plba\"=plba, \"page\"=page, \"R0\"=R0)\n\n    return(DataList)\n}\n",
    "created" : 1459286620479.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3798603966",
    "id" : "C1FFE3A3",
    "lastKnownWriteTime" : 1459286883,
    "path" : "C:/Git_Projects/fishing_recruitment_tradeoff/functions/SimData.R",
    "project_path" : "functions/SimData.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}